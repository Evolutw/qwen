# Qwen LibTorch C++ éƒ¨ç½² - ä¾¿æ·æ„å»ºè„šæœ¬

# é»˜è®¤æ„å»ºç›®å½•
BUILD_DIR = cpp/build
BIN_DIR = $(BUILD_DIR)/bin

# é»˜è®¤ç›®æ ‡
.PHONY: all
all: build

# åˆå§‹åŒ–æ„å»ºç›®å½•
.PHONY: init
init:
	@echo "ğŸ”§ åˆå§‹åŒ–æ„å»ºç¯å¢ƒ..."
	@mkdir -p $(BUILD_DIR)
	@cd $(BUILD_DIR) && cmake ..
	@echo "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

# æ¸…ç†æ„å»º
.PHONY: clean
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@rm -rf $(BUILD_DIR)/*
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ„å»ºæ‰€æœ‰ç›®æ ‡
.PHONY: build
build: init
	@echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."
	@cd $(BUILD_DIR) && make -j$(shell nproc)
	@echo "âœ… ç¼–è¯‘å®Œæˆ"

# æ„å»ºç‰¹å®šç›®æ ‡
.PHONY: chat
chat: init
	@echo "ğŸ”¨ ç¼–è¯‘èŠå¤©æµ‹è¯•..."
	@cd $(BUILD_DIR) && make test_qwen_chat
	@echo "âœ… test_qwen_chat ç¼–è¯‘å®Œæˆ"

.PHONY: quick
quick: init
	@echo "ğŸ”¨ ç¼–è¯‘å¿«é€Ÿæµ‹è¯•..."
	@cd $(BUILD_DIR) && make quick_chat_test
	@echo "âœ… quick_chat_test ç¼–è¯‘å®Œæˆ"

.PHONY: tests
tests: init
	@echo "ğŸ”¨ ç¼–è¯‘æ‰€æœ‰æµ‹è¯•..."
	@cd $(BUILD_DIR) && make test_embedding test_attention test_transformer test_qwen_model
	@echo "âœ… æµ‹è¯•ç¨‹åºç¼–è¯‘å®Œæˆ"

.PHONY: diagnostics
diagnostics: init
	@echo "ğŸ”¨ ç¼–è¯‘è¯Šæ–­å·¥å…·..."
	@cd $(BUILD_DIR) && make diagnose_model diagnose_chat diagnose_hidden_states
	@echo "âœ… è¯Šæ–­å·¥å…·ç¼–è¯‘å®Œæˆ"

# è¿è¡Œæµ‹è¯•
.PHONY: run-chat
run-chat: chat
	@echo "ğŸš€ è¿è¡ŒèŠå¤©æµ‹è¯•..."
	@$(BIN_DIR)/test_qwen_chat

.PHONY: run-quick
run-quick: quick
	@echo "ğŸš€ è¿è¡Œå¿«é€ŸèŠå¤©..."
	@$(BIN_DIR)/quick_chat_test

# å¸®åŠ©ä¿¡æ¯
.PHONY: help
help:
	@echo "Qwen LibTorch C++ éƒ¨ç½² - æ„å»ºè„šæœ¬"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make init          - åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
	@echo "  make build         - ç¼–è¯‘æ‰€æœ‰ç›®æ ‡"
	@echo "  make clean         - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make chat          - ç¼–è¯‘èŠå¤©æµ‹è¯•"
	@echo "  make quick         - ç¼–è¯‘å¿«é€ŸèŠå¤©æµ‹è¯•"
	@echo "  make tests         - ç¼–è¯‘æ‰€æœ‰å•å…ƒæµ‹è¯•"
	@echo "  make diagnostics   - ç¼–è¯‘è¯Šæ–­å·¥å…·"
	@echo "  make run-chat      - ç¼–è¯‘å¹¶è¿è¡ŒèŠå¤©æµ‹è¯•"
	@echo "  make run-quick     - ç¼–è¯‘å¹¶è¿è¡Œå¿«é€ŸèŠå¤©"
	@echo "  make help          - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
